'use strict';

const express = require('express');
const bodyParser = require('body-parser');
const methodOverride = require('method-override');

const app = express();

app.use(bodyParser.json({
  limit: '16mb'
}));
app.use(methodOverride('X-HTTP-Method-Override'));

function authorize(req, res, next) {
  if (!req.query.key || req.query.key !== process.env.KEY) {
    return res.status(401).send('Unauthorized');
  }
  return next();
}

// Add the routes.
const routes = require('./routes');
routes.forEach((route) => {
  const service = new route.service(route.config); // eslint-disable-line new-cap
  app.use(route.path, authorize, service.router);
});

module.exports = app;
